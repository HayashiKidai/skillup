---
layout: default
---
# STEP3-4.単体テストを書いてみる

実際に単体テストを書いてみましょう。CakePHPではPHPUnitというテストツールを使用して単体テストを自動化することができます。まずはPHPUnitをインストールします。phpをインストールしたディレクトリ（WindowsならC:\xampp\php）に移動し、以下のコマンドを管理者権限で実行します。

    pear upgrade PEAR
    pear config-set auto_discover 1
    pear install pear.phpunit.de/PHPUnit

さらに、コード網羅率を調べるためにXDebugというデバッグツールをインストールします。

    pecl install xdebug

XDebugを有効にするため、php.iniを編集します。下部に以下のような行があるので先頭のセミコロンを削除してコメントアウトを外し、Apacheを再起動します。

    ;zend_extension = "C:\xampp\php\ext\php_xdebug.dll"

次にテスト用のデータベースを作成します。phpmyadminを利用して、構造のみをエクスポート・インポートすると簡単です。テスト用データベースの接続情報を/app/Config/database.php内のDATABASE_CONFIGクラスにある$testに記述します。これでテストを実行する準備が整いました。[http://localhost/cakephp/test.php](http://localhost/cakephp/test.php)にアクセスするとCakePHP Test Suiteというページが表示されるはずです。

テストケースを作成してみましょう。今回は[STEP2-7.CakePHPでログイン機能を書いてみる](../2/7.html)で作成したUserモデルのバリデーションのテストを作成します。各バリデーションの仕様に対して、エラーになる代表的な値と、エラーにならない代表的な値についてテストを行うのでブラックボックステストの同値分割に該当します。以下の内容を/app/Test/Case/Model/UserTest.phpという名前で保存します。

```php
<?php
//Authコンポーネントを読み込んでおく
App::uses('AuthComponent', 'Controller/Component');

class UserTest extends CakeTestCase {
  //全てのテストの前に実行される
  public function setUp() {
    parent::setUp();
    //Userモデルを読み込む
    $this->User = ClassRegistry::init('User');
  }

  //バリデーションのテスト用メソッド
  public function testValidation(){
    //isUniqueルールチェックのためにダミーユーザー追加
    $this->User->save(array('username' => 'testUser', 'password' => 'testPassword'));
  	
    //テストケースを用意
    $cases = array(
      array(
        //与えるデータ
        'data' => array(
          'username' => '',
          'password' => ''
        ),
        //期待される結果
        'expect' => array(
          'username' => false, //requiredエラー
          'password' => false  //requiredエラー
        )
      ),
      array(
        'data' => array(
          'username' => 'teamLab',
          'password' => 'short'
        ),
        'expect' => array(
          'username' => true,
          'password' => false //betweenエラー
        )
      ),
      array(
        'data' => array(
          'username' => 'VerrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrryLongName',
          'password' => 'nicePassword123'
        ),
        'expect' => array(
          'username' => false, //betweenエラー
          'password' => true
        )
      ),
      array(
        'data' => array(
          'username' => 'testUser',
          'password' => 'パスワード'
        ),
        'expect' => array(
          'username' => false, //isUniqueエラー
          'password' => false  //alphaNumericエラー
        )
      )
    );
    
    foreach($cases as $case){
      //各ケースを実行
      $this->User->create($case['data']);
      //バリデーションエラーになった列名を取得
      $results = $this->User->invalidFields();
      foreach($case['expect'] as $key => $value){
      	//テストを実行する
        $result = !array_key_exists($key, $results);
        $this->assertEquals($result, $value);
      }
    }
  }
}
?>
```

$this->assertEquals関数がテストの本体で、第一引数に実行結果を、第二引数に期待している結果を書きます。

もう一度[http://localhost/cakephp/app/webroot/test.php](http://localhost/cakephp/app/webroot/test.php)にアクセスしてみます。テストケースに「Model / User」という項目ができていると思います。クリックしてみましょう。クリックするとUserTestが実行されます。成功したケースは緑色、失敗したケースは赤色で示されます。「Analyze Code Coverage」をクリックするとコード網羅率(C0)を調べることもできます。網羅率100%を目指してテストを作成しましょう。