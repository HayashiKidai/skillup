---
layout: default
---
# STEP3-1.Ajaxを使ってみる

Ajaxとは、JavaScriptなどからHTTP通信をすることによって、ページのリロードをせずにサーバとデータのやり取りをする技術です。ここでは簡単なチャットを作成してみます。

まずはAjaxで取得するデータを用意しましょう。データはSTEP1で作成した掲示板のデータを流用することにします。以下の内容をajax_get_data.phpという名前で保存します。今回はCakePHPは使用しませんのでhtdocsに保存してください。

```php
<?php
$mysqli = new mysqli('localhost', 'root', '', 'board');
$json = array();
$result = $mysqli->query("SELECT * FROM datas ORDER BY created DESC");
if($result){
  while($row = $result->fetch_object()){
    $json[] = array(
      "name" => htmlspecialchars($row->name),
      "message" => htmlspecialchars($row->message),
      "created" => htmlspecialchars($row->created)
    );
  }
}
print json_encode($json);
?>
```

これは1つの連想配列にdatasテーブルのデータを全て入れた後、JSONという形式に変換して出力しているコードです。[http://localhost/skillup/ajax_get_data.php](http://localhost/skillup/ajax_get_data.php)にアクセスして実際のJSONデータを見てみましょう。そのままでは非常に分かりにくいので[JSONView](https://chrome.google.com/webstore/detail/jsonview/chklaanhfefbnpoihckbnefhakgolnmc)などを使用すると良いでしょう。JSON形式はとても簡単にJavaScriptのオブジェクトに変換できるためAjaxではよく使用されています。

次は発言を保存する処理を書きます。以下の内容をajax_submit.phpという名前で保存します。

```php
<?php
if(!empty($_POST["name"]) && !empty($_POST["message"])){
  $mysqli = new mysqli('localhost', 'root', '', 'board');
  $stmt = $mysqli->prepare("INSERT INTO datas (name, message) VALUES (?, ?)");
  $stmt->bind_param('ss', $_POST["name"], $_POST["message"]);
  $stmt->execute();
}
?>
```

さて、いよいよクライアント側です。以下の内容をchat.htmlに保存します。

```html
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>簡易チャット</title>
    <script src="http://code.jquery.com/jquery-2.0.0.min.js"></script>
    <script src="chat.js"></script>
  </head>
  <body>
    <h1>簡易チャット</h1>
    名前：<input id="name" name="name" />
    内容：<input id="message" name="message" />
    <button id="submit">発言</button>
    <hr />
    <button id="update">更新</button>
    <div id="main"></div>
  </body>
</html>
```

chat.jsは以下のように記述します。

```js
//ajax_get_data.phpからJSONデータを受け取ってHTMLを書き換える関数
function update(){
  //JSON形式のデータを読み込む
  //成功時、dataにJSONデータが格納されている
  $.getJSON("ajax_get_data.php", function(data){
  	//htmlを組み立ててmainを書き換え
    html = "";
    for(i = 0; i < data.length; i++){
      html += "<b>" + data[i]["name"] + "</b> " + data[i]["message"];
      html += " (" + data[i]["created"] + ")<hr />";
    }
    $("#main").html(html);
  });
}

$(function(){
  //まず読み込み
  update();
  //更新ボタンを押したら読み込み
  $("#update").click(update);
  
  //発言ボタンを押したときの動作
  $("#submit").click(function(){
  	//送信するデータを準備
  	data = {
      name: $("#name").val(),
      message: $("#message").val()
    };
    //POSTで送信
    //引数はURL, 送信するデータ, 成功時に実行される関数
    $.post("ajax_submit.php", data, update);
  });
});
```

ここでは$.getJSON関数と$.post関数を使用しました。他にAjaxに使用できる関数は[Ajax - jQuery 日本語リファレンス](http://semooh.jp/jquery/api/ajax/)を参照してください。

では[http://localhost/skillup/chat.html](http://localhost/skillup/chat.html)を見てみましょう。ページ読み込み後、しばらくしたら発言一覧が表示されるはずです。発言ボタンや更新ボタンもチェックしてみましょう。

***

**[課題]CakePHPでのJSONの使用方法を調べよう**  
CakePHPでもJSON形式での出力をサポートしています。JSON形式で出力する方法を調べて使ってみましょう。